<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚²ãƒ¼ãƒ äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    #calendar {
      max-width: 900px;
      margin: 20px auto;
    }
    .status-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 900;
      font-size: 26px;
      pointer-events: none;
      user-select: none;
      font-family: "Arial Black", Arial, sans-serif;
    }
    #reserve-form {
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #reserve-result {
      font-weight: bold;
      margin-top: 10px;
      text-align: center;
    }
    button {
      cursor: pointer;
      padding: 6px 14px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #333;
      background-color: #f0f0f0;
      margin-right: 10px;
    }
    button:hover {
      background-color: #ddd;
    }
    #login-area {
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #666;
      border-radius: 6px;
      text-align: center;
      position: relative;
    }
    #login-area input {
      margin: 0 5px;
      padding: 5px;
    }
    /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ */
    #menu-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      font-family: Arial, sans-serif;
    }
    #menu-btn {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
      user-select: none;
    }
    #menu {
      display: none; /* åˆæœŸã¯éè¡¨ç¤º */
      position: absolute;
      top: 40px;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 280px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 10px;
    }
    #menu h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }
    #reservation-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 250px;
      overflow-y: auto;
    }
    #reservation-list li {
      padding: 6px 4px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      user-select: none;
    }
    #reservation-list li:hover {
      background-color: #eee;
    }
    #reservation-detail {
      margin-top: 10px;
      font-size: 14px;
      color: #333;
      white-space: pre-line;
    }
    /* è¿½åŠ ï¼šã€‡â–³âœ•ã®è‰²åˆ†ã‘ã‚¯ãƒ©ã‚¹ */
    .status-ã€‡ {
      color: green;
    }
    .status-â–³ {
      color: orange;
    }
    .status-âœ• {
      color: red;
    }

    /* ã“ã“ã‹ã‚‰ãŠçŸ¥ã‚‰ã›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #notice-area {
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #999;
      border-radius: 6px;
      background-color: #fafafa;
    }
    #notice-area h3 {
      margin-top: 0;
      font-size: 18px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }
    #notice-content p {
      margin: 6px 0;
      font-size: 14px;
    }
     /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®è¦ªã‚’flexã§æ¨ªä¸¦ã³ï¼ˆPCç”¨ï¼‰ */
  #login-area .input-group {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
  }

  #login-area input {
    margin: 0 5px;
    padding: 5px;
    width: 200px;
  }

  /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚‚æ¨ªä¸¦ã³ */
  #login-area .input-group button {
    margin: 0 5px;
  }

  /* ã‚¹ãƒãƒ›ï¼ˆå¹…600pxä»¥ä¸‹ï¼‰ã®å ´åˆã¯ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
  @media screen and (max-width: 600px) {
    #login-area .input-group {
      flex-direction: column;
      align-items: stretch;
    }

    #login-area input,
    #login-area select {
      margin: 5px 0;
      width: 96%;
    }

    #login-area .input-group button {
      margin: 5px 0;
      width: 100%;
    }
  }
  </style>
</head>
<body>

<h1 style="text-align:center;">ã‚²ãƒ¼ãƒ äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>

<!-- ä¿®æ­£ï¼šidå¤‰æ›´ã¨ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡æ›¿ã®ãŸã‚ã®idè¿½åŠ  -->
<div id="login-area">
  <div class="input-group">
    <select id="account-type">
      <option value="TikTok">TikTok</option>
      <option value="YouTube">YouTube</option>
    </select>
    <input type="text" id="accountName" placeholder="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå" />
    <input type="text" id="epicId" placeholder="Epic ID" />
    <input type="text" id="subId" placeholder="ã‚µãƒ–ã‚¹ã‚¯IDï¼ˆä»»æ„ï¼‰" />
    <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logout-btn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
  <p id="login-result"></p>
</div>
<button id="force-lottery-btn" style="display: none;">ğŸ¯ æŠ½é¸ã‚’å¼·åˆ¶å®Ÿè¡Œã™ã‚‹</button>
<div id="lottery-result-message"></div>


<!-- ãŠçŸ¥ã‚‰ã›æ¬„ -->
<div id="notice-area">
  <h3>ãŠçŸ¥ã‚‰ã›</h3>
  <div id="notice-content">äºˆç´„æ—¥å½“æ—¥ã®æŠ½é¸çµæœã¯ã“ã¡ã‚‰ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
</div>

<!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="menu-container">
  <button id="menu-btn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">&#9776;</button>
  <div id="menu">
    <h3>äºˆç´„ä¸€è¦§</h3>
    <ul id="reservation-list"></ul>
    <div id="reservation-detail"></div>
  </div>
</div>

<div id="calendar"></div>

<div id="reserve-form" style="display:none;">
  <h3>äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h3>
  <label>åå‰: <span id="display-name"></span></label><br/><br/>
  <label>æ—¥ä»˜: <input type="date" id="reserve-date" readonly /></label><br/><br/>
  <label>æ™‚é–“:
    <select id="reserve-time">
      <option value="09:00-10:00">09:00ã€œ10:00ï¼ˆ1æ™‚é–“ï¼‰</option>
      <option value="10:00-11:00">10:00ã€œ11:00ï¼ˆ1æ™‚é–“ï¼‰</option>
      <option value="11:00-12:00">11:00ã€œ12:00ï¼ˆ1æ™‚é–“ï¼‰</option>
      <option value="09:00-11:00">09:00ã€œ11:00ï¼ˆ2æ™‚é–“ï¼‰</option>
      <option value="10:00-12:00">10:00ã€œ12:00ï¼ˆ2æ™‚é–“ï¼‰</option>
      <option value="09:00-12:00">09:00ã€œ12:00ï¼ˆ3æ™‚é–“ï¼‰</option>
    </select>
  </label><br/><br/>
  <button id="reserve-btn">äºˆç´„ã™ã‚‹</button>
  <button id="cancel-btn">äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  <p id="reserve-result"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="main.js"></script>

<script>
  // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰å‡¦ç†
  const menuBtn = document.getElementById('menu-btn');
  const menu = document.getElementById('menu');
  const reservationList = document.getElementById('reservation-list');
  const reservationDetail = document.getElementById('reservation-detail');
  
  // menuBtn.addEventListener('click', async () => {
  //   if (menu.style.display === 'block') {
  //     menu.style.display = 'none';
  //     reservationList.innerHTML = '';
  //     reservationDetail.textContent = '';
  //   } else {
  //     menu.style.display = 'block';
  //     await fetchReservationsAndShow();
  //   }
  // });
 menuBtn.addEventListener('click', async () => {
  if (menu.style.display === 'block') {
    menu.style.display = 'none';
  } else {
    menu.style.display = 'block';
    await fetchReservationsAndShow(); // â† ã“ã“é‡è¦
  }
});


// âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
  document.addEventListener('click', (event) => {
    if (!menu.contains(event.target) && !menuBtn.contains(event.target)) {
      menu.style.display = 'none';
    }
  });
  
  // âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰äºˆç´„ä¸€è¦§ã‚’åˆæœŸè¡¨ç¤º
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const resSession = await fetch('/session');
      const sessionData = await resSession.json();
      if (sessionData.loggedIn) {
        fetchReservationsAndShow();
      }
    } catch (e) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªå¤±æ•—', e);
    }
  });


  async function fetchReservationsAndShow() {
    try {
      const resSession = await fetch('/session');
      const sessionData = await resSession.json();
      const isAdmin = sessionData.loggedIn && sessionData.user.tiktokId === 'admin';

      const res = await fetch(isAdmin ? '/admin/reservations' : '/my-reservations');
      const reservations = await res.json();

      reservationList.innerHTML = '';
      reservationDetail.textContent = '';

      if (!reservations || reservations.length === 0) {
        reservationList.innerHTML = '<li>äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
        return;
      }

      reservations.forEach((r, index) => {
        const li = document.createElement('li');

        if (isAdmin) {
          // ç®¡ç†è€…ç”¨UIï¼ˆå…¨å“¡ã®äºˆç´„ã‚’è¡¨ç¤ºã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãªã—ï¼‰
          const statusMark = (r.status === 'confirmed') ? 'ã€‡' :
                             (r.status === 'pending') ? 'â–³' :
                             (r.status === 'rejected') ? 'âœ•' : '';
          li.textContent = `${r.date} ${r.time} - ${r.name} [${statusMark}]`;
          li.classList.add(`status-${statusMark}`);
          li.addEventListener('click', () => {
            reservationDetail.textContent =
              `åå‰: ${r.name}\n` +
              `Epic ID: ${r.epicid}\n` +
              `ã‚µãƒ–ã‚¹ã‚¯ID: ${r.subid || 'ãªã—'}\n` +
              `ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¨®åˆ¥: ${r.accounttype}\n` +
              `æ—¥ä»˜: ${r.date}\n` +
              `æ™‚é–“: ${r.time}\n` +
              `çŠ¶æ…‹: ${r.status}`;
          });
         } else {
        //   // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨UIï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ä»˜ãï¼‰
           const statusLabel = r.status === 'pending' ? 'â³æŠ½é¸å¾…ã¡' :
                               r.status === 'confirmed' ? 'âœ…ç¢ºå®š' :
                               r.status === 'rejected' ? 'âŒè½é¸' : '';
           li.innerHTML = `
             <div style="display: flex; justify-content: space-between; align-items: center;">
               <span style="flex-grow: 1; cursor: pointer;" data-index="${index}">
                 ${r.date} ${r.time} ${statusLabel}
               </span>
               <button class="cancel-inline-btn" style="font-size: 12px; padding: 2px 6px;" data-date="${r.date}" data-time="${r.time}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
             </div>
           `;
           li.querySelector('span').addEventListener('click', () => {
             reservationDetail.textContent = `äºˆç´„æ—¥æ™‚: ${r.date} ${r.time}\nçŠ¶æ…‹: ${statusLabel}\nEpic ID: ${r.epicid}`;
           });
           li.querySelector('.cancel-inline-btn').addEventListener('click', async () => {
             const confirmCancel = confirm(`ã€Œ${r.date} ${r.time}ã€ã®äºˆç´„ã‚’æœ¬å½“ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`);
             if (!confirmCancel) return;
             const res = await fetch('/cancel', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ date: r.date, time: r.time })
             });
             const result = await res.json();
             alert(result.message);
             await fetchReservationsAndShow();
             renderStatusLabels();
           });
        }

        reservationList.appendChild(li);
      });

      // æœ€åˆã®äºˆç´„ã®è©³ç´°ã‚’è¡¨ç¤ºï¼ˆä¸€èˆ¬ã®ã¿ï¼‰
      if (!isAdmin) {
        reservationDetail.textContent = `äºˆç´„æ—¥æ™‚: ${reservations[0].date} ${reservations[0].time}`;
      }

    } catch (e) {
      reservationList.innerHTML = '<li>äºˆç´„æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</li>';
    }
    if (typeof renderStatusLabels === 'function') {
  renderStatusLabels();
}

  }
</script>


</body>
</html>
